<!doctype html>
<!--Author: Joachim Pietsch
//Date 29/10/2013
//Changes: this version will draw a Rectangle between 2 mouseclicks
-->


<html>
  <head>
    <meta charset="utf-8">
    <title>Drawing App version 3</title>
	<link rel="stylesheet" type="text/css" href="buttons.css" />
	<link rel="stylesheet" type="text/css" href="menu.css" />
  </head>
	<script src="openPath.js"></script>
	<script src="rect.js"></script>

	<script>

	var canvas;
	var context;
	var strokeSize = 3;
	var strokeColor = '#999999';
	var fillColor = '#ffffff';
	var bgColor = '#cc99cc';
	var mouse = {};
	var canvasObj = [] ; //will store objects on the canvas.
	var tempPath = {}  ;  // the path that is being currently constructed
	var theMode = "drawing"; //can be shapes or drawing
	var myRect;
	var tempRect;
	var clickCount = 0;
	var myGradient;


	function init() {

	  canvas = document.getElementById('canvas');
      context = canvas.getContext('2d');
	  drawCanvas(context);
	  //define a gradient
	   myGradient = context.createLinearGradient(108, 180, 308,180);
	   myGradient.addColorStop(0, '#8ED6FF');
	   myGradient.addColorStop(1, '#004CB3');
	  /*creating and drawing test Rectangle;
		  myRect = new rect(context, '#333333', 6, '#999999');
		  myRect.setPoints({x:50 , y:50});
		  myRect.setPoints({x:100 , y:100});
		  if (myRect.points.length == 2) {
		  		myRect.draw();
	  }

	  console.log("initial length of myRect.points: " + myRect.points.length);
	  */

	  //instantiating our menu
	  nav = new Menu(document.getElementById('menu'));
	  nav.init();
	  //Eventlisteners
	  // to the mousedown element
	  canvas.addEventListener('mousedown', onMouseDown, false);
	  //listening to mouseOut element
      canvas.addEventListener('mouseout', onMouseOut, false);
	  //removing mouseMove EL


      canvas.addEventListener('mouseup', mouseUp, false);



    }

	//this function draws the canvas by  looping through
	//every item in canvObj array and running the drawing method of each
	//element.
	function drawCanvas(ctx) {
      if (ctx === undefined) {
      	canvas = document.getElementById('canvas');
      	ctx = canvas.getContext('2d');
  	}

    	ctx.beginPath();
	  	ctx.rect(0,0,canvas.width,canvas.height);
	  	ctx.fillStyle = bgColor;
	 	ctx.fill();
	  	ctx.closePath();

    	console.log(canvasObj);
    	//draw out all the Shapes in the Canvas Object
    	for (i = 0; i < canvasObj.length; i++) {
    		var curPath = canvasObj[i];
    		canvasObj[i].draw();
    	}
    }



	//when the  mouse is down
	function onMouseDown (e) {
		e = e || event;
		mouse = getMouse(e);
		console.log("mouseDown Event");
		switch (theMode) {
			case "drawing":
				console.log("==drawing Mode");
				canvas.addEventListener('mousemove', onMouseMove, false);
				tempPath = new openPath(context, strokeColor, strokeSize);
			break;
			case "shapes":
				console.log("==shapes Mode");
				canvas.removeEventListener('mousemove', onMouseMove, false);
				if (clickCount==0) {
					console.log("tempRect created");
					tempRect = new rect(context,strokeColor, strokeSize, fillColor);
				}

			break;

		}


    }

   //when the mouse is UP
   function mouseUp() {
           	switch (theMode) {
			case "drawing":
				canvasObj.push(tempPath);
        		canvas.removeEventListener('mousemove', onMouseMove, false);
			break;
			case "shapes":

				clickCount ++;
				console.log("adding points");
				tempRect.setPoints(mouse);
				if (clickCount==2) {
					console.log("2 clicks .");
					canvasObj.push(tempRect);
					clickCount = 0;
				}

			break;
		}

      console.log(canvasObj);
	  // now draw the Canvas again
	  drawCanvas();


     }

     //Event Listeners go here:

	//stops drawing line when the mouse is outside the canvas and
	//moved back in while still clicked.
	function onMouseOut (e) {
		console.log("mouse is outside the canvas");
		context.closePath();
		canvas.removeEventListener('mousemove', onMouseMove, false);
	}


	//while the mouse is moving
	function onMouseMove (e) {
		//monitoring mouseClicks;
		e = e || event;
		// console.log(e);
		mouse = getMouse(e);
		tempPath.setPoints(mouse);
		tempPath.draw();

    }


    //utility function to get the Mouse position
    //return it as a an object.
    function  getMouse(e) {
    	e = e || event;
	    var rect = this.canvas.getBoundingClientRect();
	        return {
	          x: e.clientX - rect.left,
	          y: e.clientY - rect.top
			}
	}



	//Menu constructor: uses event delegation
 	function Menu(elem) {

			var myCanvas = canvas;

			this.init = function() {
				document.getElementById('strokeSize').value = strokeSize;
			}

  			this.onDraw = function() {

  				   	console.log("drawing");
						theMode = "drawing";
						strokeSize -=  10;
						strokeColor = '#999999';
  			};

  			this.onRect = function(){
					theMode = "shapes";
					console.log("drawing a rectangle");

			};

  			this.onErase = function(){
					console.log("erasing");
					    theMode = "drawing";
						strokeSize +=  10;
						strokeColor = bgColor;
			};

			this.onEraseAll = function(){
					console.log("erasing All");
					canvasObj = new Array();
					drawCanvas(context);
			};

			this.onRect = function(){
					theMode = "shapes";
					console.log("drawing a rectangle");

			};

			this.onSave = function(){
					console.log("saving canvas");
					window.open(canvas.toDataURL("image/png"));
			};




  			var self = this;



			elem.onclick = function(e) {
			   console.log("click event")
			   var target = e && e.target || event.srcElement;
			   var action = target.getAttribute('btn-action');
			    if (action) {
			      self["on"+action]();
			   		}


			elem.onchange = function(e) {
					console.log("change event")
				 	var target = e && e.target || event.srcElement;
				   	//checking for strokeValue range Slider
				   	if (target.id == "strokeSize")	{
				   		console.log("clicked on strokeSize" );
				   		console.log(target.value);
				   		strokeSize = parseInt(target.value);
				   	}

				   	//checking for strokeValue range Slider
				   	if (target.id == "strokecolor")	{
				   		console.log("clicked on stroke color" );
				   		strokeColor = target.value;
				   		console.log(strokeColor);
				   	}

				   	//checking for strokeValue range Slider
				   	if (target.id == "fillcolor")	{
				   		console.log("clicked on fill color" );
				   		fillColor = target.value;
				   		console.log(strokeColor);
				   	}

				   	//checking for strokeValue range Slider
				   	if (target.id == "bgcolor")	{
				   		console.log("clicked on bg color" );
				   		bgColor = target.value;
				   		console.log(bgColor);
				   		drawCanvas(context);
				   	}

			   	}

			}
    }


	</script>

  <body onload="init()">

	<h1>Click and draw with the mouse.</h1>

    <canvas id="canvas" width="600" height="400" style="border:1px solid #d3d3d3 bgcolor;">
    	Canvas not supported
    </canvas>



	<div id="menu">
	<ul >
		  <li><a class="button" btn-action="Draw">Draw</a></li>
		  <li><a class="button" btn-action="Erase">Erase</a></li>
		  <li><a class="button" btn-action="EraseAll">Erase All</a></li>
		  <li><a class="button" btn-action="Rect">Rectangle</a></li>
		  <li><a class="button" btn-action="Save">Save</a></li>

	</ul>
	<form>
		Stroke Size:
		<input type='range'  id='strokeSize' step="1" min="1" max="10" title="stroke Size"  value="1"/>
	  	Stroke Color:
	  	<input type='color' id='strokecolor' / value="#ffffff" />
	  	Fill Color:
	  	<input type='color' id='fillcolor' / value="#ffffff" />
	  	Bg Color:
	  	<input type='color' id='bgcolor' / value="#ffffff" />

  	</form>
  </div>
  </body>
</html>
